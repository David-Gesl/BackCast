<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Backcast</title>
    <style>
        body { margin: 0; }
        canvas { display: block; }
    </style>
</head>
<body>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js",
                "three/addons/": "https://threejs.org/examples/jsm/",
                "three/examples/jsm/controls/OrbitControls.js": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/controls/OrbitControls.js",
                "three/examples/jsm/loaders/FBXLoader.js": "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/loaders/FBXLoader.js"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';
        import { FBXLoader } from 'three/examples/jsm/loaders/FBXLoader.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
        import { MTLLoader } from 'three/addons/loaders/MTLLoader.js' 
        import { GUI } from 'three/addons/libs/lil-gui.module.min.js'

        let scene, camera, renderer, controls, directionalLight, lampLight;

        // const gui = new GUI();

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color( 'black' );

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(50, 45, 50);
            camera.lookAt(new THREE.Vector3(0,0,0));

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 1, 0);
            controls.update();

            // Add the lamp light
            lampLight = new THREE.SpotLight(0xffb74d, 0.1);
            const lampLight2 = new THREE.PointLight(0xffb74d, 0.05);
            const helper = new THREE.PointLightHelper(lampLight);
            lampLight2.position.set(-1.9, 13.8, 6);
            lampLight.position.set(-1.9, 13.8, 6);
            lampLight.target.position.set(-10,-18,-15);
            lampLight.penumbra = 1;
            lampLight.angle = THREE.MathUtils.degToRad(180);
            lampLight.castShadow = true;
            lampLight2.castShadow = true;
            scene.add(lampLight);
            scene.add(lampLight.target)
            scene.add(lampLight2);

            // Load Radio model
            const fbx_loader = new FBXLoader();
            fbx_loader.load('../static/models/radio/radio.fbx', (object) => {
                object.traverse((child) => {
                    if (child.isMesh) {
                        const textureLoader = new THREE.TextureLoader();
                        const texture = textureLoader.load('../static/models/radio/textures/blinn1_Base_color.png');
                        child.material.map = texture;
                        child.material.needsUpdate = true;
                    }
                });
                scene.add(object);
                object.position.set(7, 12, -8.5);
            });

            // Load room
            const gltf_loader = new GLTFLoader();
            gltf_loader.load('../static/models/room/room.glb', (gltf) => {
                const object = gltf.scene;

                object.position.set(0, 0, 0);
                object.scale.set(10, 10, 10);
                scene.add(object);

                // compute the box that contains all the stuff
                // from object and below
                const box = new THREE.Box3().setFromObject( object );

                const boxSize = box.getSize( new THREE.Vector3() ).length();
                const boxCenter = box.getCenter( new THREE.Vector3() );


                // update the Trackball controls to handle the new size
                controls.maxDistance = boxSize * 10;
                controls.target.copy( boxCenter );
                controls.update();
            })

            window.addEventListener('resize', onWindowResize, false);

            animate();
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            controls.update();
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
        }

        init();
    </script>
    <script>
        // Function to fetch and play the audio stream
        async function playAudioStream() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const audioElement = new Audio('/feed');
            const track = audioContext.createMediaElementSource(audioElement);
            track.connect(audioContext.destination);
            await audioElement.play();
        }
        addEventListener('mousedown', function() {
            playAudioStream().catch(console.error);
        });
    </script>
    </body>
</body>
</html>
